<?php
/**
 * Created by PhpStorm.
 * User: Thomas
 * Date: 03/06/2019
 * Time: 11:20
 */
include ('connexion.php');

function getTramesBatchv2() {
    $raw = recupLogsBrutShort();


    $intermediaire = decoupeLogsBrutShort($raw);
    //var_dump($intermediaire);
    $res = array();


    for ($i=0; $i < count($intermediaire); $i++) {
        $t = decodageTrameLiveChart(strrev($intermediaire[$i]));
        array_push($res,$t);
    }

    return $res;

}



function recupLogsBrutShort()
{

    $ch = curl_init();

    curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_URL, "http://projets-tomcat.isep.fr:8080/appService/?ACTION=GETLOG&TEAM=007D");
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);

    $data = curl_exec($ch);
    curl_close($ch);


    //$data=file_get_contents("http://projets-tomcat.isep.fr:8080/appService/?ACTION=GETLOG&TEAM=007D");
    //echo "Donnée brute:<br />";
    //echo("$data");
    //get the last 1000 characters of $raw ( ~ the last 30 trames )
    $n = 1000;
    $start = strlen($data) - $n;
    $reduced = '';

    for ($x = $start; $x < strlen($data); $x++) {

        // Appending characters to the new string
        $reduced .= $data[$x];
    }

    return $reduced;
}

function getTramesFromRepere($bdd,$pieceSelect){
    //$raw = recupLogsBrut();
    $raw = "1007D13010128BABAA2201906031112211007D17010019BABAA5201906031112211007D15010FFFBABADB201906031112211007D1301012BBABAAC201906031112221007D17010019BABAA5201906031112221007D15010FFFBABADB201906031112221007D1301012FBABAB0201906031112231007D17010017BABAA3201906031112231007D15010FFFBABADB201906031112231007D1301012BBABAAC201906031112241007D1701001BBABAAE201906031112241007D15010FFFBABADB201906031112241007D13010129BABAA3201906031112261007D1701001BBABAAE201906031112261007D15010FFFBABADB201906031112261007D13010127BABAA1201906031112271007D17010019BABAA5201906031112271007D15010FFFBABADB201906031112271007D1301012FBABAB0201906031112281007D17010019BABAA5201906031112281007D15010FFFBABADB201906031112281007D13010130BABA9B201906031112291007D17010018BABAA4201906031112291007D15010FFFBABADB201906031112291007D1301012BBABAAC201906031112301007D17010018BABAA4201906031112301007D15010FFFBABADB201906031112301007D13010129BABAA3201906031112311007D1701001BBABAAE201906031112321007D15010FFFBABADB201906031112321007D1301012BBABAAC201906031112331007D17010019BABAA5201906031112331007D15010FFFBABADB201906031112331007D1301012BBABAAC201906031112341007D17010017BABAA3201906031112341007D15010FFFBABADB201906031112341007D1301012FBABAB0201906031112351007D17010019BABAA5201906031112351007D15010FFFBABADB201906031112351007D1301012BBABAAC201906031112361007D1701001BBABAAE201906031112361007D15010FFFBABADB201906031112361007D13010125BABA9F201906031112371007D1701001BBABAAE201906031112381007D15010FFFBABADB201906031112381007D13010128BABAA2201906031112391007D1701001BBABAAE201906031112391007D15010FFFBABADB201906031112391007D1301012BBABAAC201906031112401007D17010017BABAA3201906031112401007D15010FFFBABADB201906031112401007D1301012BBABAAC201906031112411007D1701001BBABAAE201906031112411007D15010FFFBABADB201906031112411007D13010127BABAA1201906031112421007D17010019BABAA5201906031112421007D15010FFFBABADB201906031112421007D13010128BABAA2201906031112431007D1701001BBABAAE201906031112441007D15010FFFBABADB201906031112441007D1301012BBABAAC201906031112451007D17010017BABAA3201906031112451007D15010FFFBABADB201906031112451007D1301012EBABAAF201906031112461007D1701001BBABAAE201906031112461007D15010FFFBABADB201906031112461007D13010129BABAA3201906031112471007D17010017BABAA3201906031112471007D15010FFFBABADB201906031112471007D13010126BABAA0201906031112481007D1701001BBABAAE201906031112481007D15010FFFBABADB201906031112481007D13010125BABA9F201906031112491007D17010017BABAA3201906031112491007D15010FFFBABADB201906031112501007D1301012BBABAAC201906031112511007D17010017BABAA3201906031112511007D15010FFFBABADB201906031112511007D1301012BBABAAC201906031112521007D17010015BABAA1201906031112521007D15010FFFBABADB201906031112521007D13010127BABAA1201906031112531007D17010017BABAA3201906031112531007D15010FFFBABADB201906031112531007D13010127BABAA1201906031112541007D17010019BABAA5201906031112541007D15010FFFBABADB201906031112541007D1301012ABABAAB201906031112551007D17010017BABAA3201906031112551007D15010FFFBABADB201906031112561007D1301012DBABAAE201906031112571007D17010017BABAA3201906031112571007D15010FFFBABADB201906031112571007D1301012BBABAAC201906031112581007D17010015BABAA1201906031112581007D15010FFFBABADB201906031112581007D13010129BABAA3201906031112591007D17010019BABAA5201906031112591007D15010FFFBABADB201906031112591007D13010128BABAA2201906031113001007D17010019BABAA5201906031113001007D15010FFFBABADB201906031113001007D13010127BABAA1201906031113011007D17010013BABA9F201906031113011007D15010FFFBABADB201906031113021007D1301012EBABAAF201906031113031007D17010015BABAA1201906031113031007D15010FFFBABADB201906031113031007D13010129BABAA3201906031113041007D17010015BABAA1201906031113041007D15010FFFBABADB201906031113041007D13010129BABAA3201906031113051007D1701001BBABAAE201906031113051007D15010FFFBABADB201906031113051007D13010129BABAA3201906031113061007D1701001BBABAAE201906031113061007D15010FFFBABADB201906031113061007D13010129BABAA3201906031113071007D17010015BABAA1201906031113071007D15010FFFBABADB201906031113071007D1301012FBABAB0201906031113091007D17010018BABAA4201906031113091007D15010FFFBABADB201906031113091007D13010127BABAA1201906031113101007D1701001BBABAAE201906031113101007D15010FFFBABADB201906031113101007D13010127BABAA1201906031113111007D1701001BBABAAE201906031113111007D15010FFFBABADB201906031113111007D13010127BABAA1201906031113121007D17010019BABAA5201906031113121007D15010FFFBABADB201906031113121007D1301012BBABAAC201906031113131007D17010018BABAA4201906031113131007D15010FFFBABADB201906031113131007D1301012BBABAAC201906031113151007D17010019BABAA5201906031113151007D15010FFFBABADB201906031113151007D1301012BBABAAC201906031113161007D1701001ABABAAD201906031113161007D15010FFFBABADB201906031113161007D13010127BABAA1201906031113171007D17010019BABAA5201906031113171007D15010FFFBABADB201906031113171007D1301012DBABAAE201906031113181007D17010016BABAA2201906031113181007D15010FFFBABADB201906031113181007D1301012DBABAAE201906031113191007D17010017BABAA3201906031113191007D15010FFFBABADB201906031113191007D13010129BABAA3201906031113211007D17010017BABAA3201906031113211007D15010FFFBABADB201906031113211007D13010123BABA9D201906031113221007D1701001DBABAB0201906031113221007D15010FFFBABADB201906031113221007D13010125BABA9F201906031113231007D17010015BABAA1201906031113231007D15010FFFBABADB201906031113231007D1301012BBABAAC201906031113241007D17010017BABAA3201906031113241007D15010FFFBABADB201906031113241007D1301012BBABAAC201906031113251007D17010019BABAA5201906031113251007D15010FFFBABADB201906031113251007D13010127BABAA1201906031113271007D1701001BBABAAE201906031113271007D15010FFFBABADB201906031113271007D13010128BABAA2201906031113281007D1701001BBABAAE201906031113281007D15010FFFBABADB201906031113281007D13010128BABAA2201906031113291007D17010017BABAA3201906031113291007D15010FFFBABADB201906031113291007D13010130BABA9B201906031113301007D1701001BBABAAE201906031113301007D15010FFFBABADB201906031113301007D13010127BABAA1201906031113311007D17010017BABAA3201906031113311007D15010FFFBABADB201906031113311007D13010127BABAA1201906031113321007D1701001DBABAB0201906031113331007D15010FFFBABADB201906031113331007D13010129BABAA3201906031113341007D17010019BABAA5201906031113341007D15010FFFBABADB201906031113341007D13010131BABA9C201906031113351007D17010013BABA9F201906031113351007D15010FFFBABADB201906031113351007D1301012BBABAAC201906031113361007D17010017BABAA3201906031113361007D15010FFFBABADB201906031113361007D13010127BABAA1201906031113371007D1701001BBABAAE201906031113371007D15010FFFBABADB201906031113371007D13010129BABAA3201906031113381007D17010019BABAA5201906031113391007D15010FFFBABADB201906031113391007D13010129BABAA3201906031113401007D17010017BABAA3201906031113401007D15010FFFBABADB201906031113401007D1301012FBABAB0201906031113411007D17010016BABAA2201906031113411007D15010FFFBABADB201906031113411007D1301012ABABAAB201906031113421007D17010019BABAA5201906031113421007D15010FFFBABADB201906031113421007D13010128BABAA2201906031113431007D17010019BABAA5201906031113431007D15010FFFBABADB201906031113431007D13010126BABAA0201906031113441007D17010015BABAA1201906031113451007D15010FFFBABADB201906031113451007D1301012FBABAB0201906031113461007D17010013BABA9F201906031113461007D15010FFFBABADB201906031113461007D1301012FBABAB0201906031113471007D17010019BABAA5201906031113471007D15010FFFBABADB201906031113471007D1301012BBABAAC201906031113481007D1701001BBABAAE201906031113481007D15010FFFBABADB201906031113481007D13010129BABAA3201906031113491007D17010019BABAA5201906031113491007D15010FFFBABADB201906031113491007D13010127BABAA1201906031113501007D17010019BABAA5201906031113501007D15010FFFBABADB201906031113511007D1301012BBABAAC201906031113521007D17010017BABAA3201906031113521007D15010FFFBABADB201906031113521007D1301012BBABAAC201906031113531007D17010015BABAA1201906031113531007D15010FFFBABADB201906031113531007D1301012BBABAAC201906031113541007D1701001BBABAAE201906031113541007D15010FFFBABADB201906031113541007D1301012BBABAAC201906031113551007D1701000FBABAB1201906031113551007D15010FFFBABADB201906031113551007D1301012DBABAAE201906031113561007D17010017BABAA3201906031113561007D15010FFFBABADB201906031113571007D1301012FBABAB0201906031113581007D17010018BABAA4201906031113581007D15010FFFBABADB201906031113581007D1301012BBABAAC201906031113591007D17010015BABAA1201906031113591007D15010FFFBABADB201906031113591007D13010129BABAA3201906031114001007D1701001DBABAB0201906031114001007D15010FFFBABADB201906031114001007D13010129BABAA3201906031114011007D1701001BBABAAE201906031114011007D15010FFFBABADB201906031114011007D1301012FBABAB0201906031114021007D17010019BABAA5201906031114021007D15010FFFBABADB201906031114031007D1301012FBABAB0201906031114041007D17010019BABAA5201906031114041007D15010FFFBABADB201906031114041007D13010122BABA9C201906031114051007D17010017BABAA3201906031114051007D15010FFFBABADB201906031114051007D1301012BBABAAC201906031114061007D1701001BBABAAE201906031114061007D15010FFFBABADB201906031114061007D13010128BABAA2201906031114071007D1701001ABABAAD201906031114071007D15010FFFBABADB201906031114071007D13010127BABAA1201906031114081007D17010018BABAA4201906031114081007D15010FFFBABADB201906031114081007D13010132BABA9D201906031114101007D17010016BABAA2201906031114101007D15010FFFBABADB201906031114101007D1301012BBABAAC201906031114111007D17010019BABAA5201906031114111007D15010FFFBABADB201906031114111007D13010125BABA9F201906031114121007D1701001BBABAAE201906031114121007D15010FFFBABADB201906031114121007D1301012BBABAAC201906031114131007D1701001BBABAAE201906031114131007D15010FFFBABADB201906031114131007D13010129BABAA3201906031114141007D17010017BABAA3201906031114141007D15010FFFBABADB201906031114141007D13010125BABA9F201906031114161007D17010017BABAA3201906031114161007D15010FFFBABADB201906031114161007D1301012ABABAAB201906031114171007D17010017BABAA3201906031114171007D15010FFFBABADB201906031114171007D13010127BABAA1201906031114181007D17010019BABAA5201906031114181007D15010FFFBABADB201906031114181007D13010129BABAA3201906031114191007D17010017BABAA3201906031114191007D15010FFFBABADB201906031114191007D13010129BABAA3201906031114201007D17010017BABAA3201906031114201007D15010FFFBABADB201906031114201007D1301012DBABAAE201906031114221007D17010017BABAA3201906031114221007D15010FFFBABADB201906031114221007D13010125BABA9F201906031114231007D17010019BABAA5201906031114231007D15010FFFBABADB201906031114231007D13010129BABAA3201906031114241007D1701001BBABAAE201906031114241007D15010FFFBABADB201906031114241007D13010129BABAA3201906031114251007D17010015BABAA1201906031114251007D15010FFFBABADB201906031114251007D1301012BBABAAC201906031114261007D17010017BABAA3201906031114261007D15010FFFBABADB201906031114261007D1301012BBABAAC201906031114281007D17010017BABAA3201906031114281007D15010FFFBABADB201906031114281007D1301012BBABAAC201906031114291007D17010019BABAA5201906031114291007D15010FFFBABADB201906031114291007D13010129BABAA3201906031114301007D17010019BABAA5201906031114301007D15010FFFBABADB201906031114301007D1301012BBABAAC201906031114311007D17010017BABAA3201906031114311007D15010FFFBABADB201906031114311007D1301012DBABAAE201906031114321007D17010017BABAA3201906031114321007D15010FFFBABADB201906031114321007D13010128BABAA2201906031114331007D17010018BABAA4201906031114341007D15010FFFBABADB201906031114341007D13010126BABAA0201906031114351007D17010019BABAA5201906031114351007D15010FFFBABADB201906031114351007D13010127BABAA1201906031114361007D17010017BABAA3201906031114361007D15010FFFBABADB201906031114361007D1301012FBABAB0201906031114371007D17010017BABAA3201906031114371007D15010FFFBABADB201906031114371007D13010129BABAA3201906031114381007D17010015BABAA1201906031114381007D15010FFFBABADB201906031114381007D13010125BABA9F201906031114401007D1701001ABABAAD201906031114401007D15010FFFBABADB201906031114401007D13010123BABA9D201906031114411007D17010018BABAA4201906031114411007D15010FFFBABADB201906031114411007D13010129BABAA3201906031114421007D17010018BABAA4201906031114421007D15010FFFBABADB201906031114421007D1301012FBABAB0201906031114431007D17010017BABAA3201906031114431007D15010FFFBABADB201906031114431007D13010125BABA9F201906031114441007D17010019BABAA5201906031114441007D15010FFFBABADB201906031114441007D13010129BABAA3201906031114451007D17010019BABAA5201906031114461007D15010FFFBABADB201906031114461007D1301012BBABAAC201906031114471007D17010018BABAA4201906031114471007D15010FFFBABADB201906031114471007D1301012BBABAAC201906031114481007D17010017BABAA3201906031114481007D15010FFFBABADB201906031114481007D13010129BABAA3201906031114491007D17010019BABAA520190603111449";
    $nouveauRepere=strlen($raw); //taille du log actualisé
    echo "NouveauRepere=";
    var_dump($nouveauRepere);
    echo "</br>";
    $ancienRepere=recupRepere($bdd,$pieceSelect); //Taille des logs déjà traité
    if($ancienRepere==$nouveauRepere){
        echo "Logs non actualisé ou identique<br />" ;
    }
    else{
        echo "On va traiter les nouveaux logs<br />";
    }
    $rawRecent=substr($raw,$ancienRepere); // Retire les logs déjà traité
    $intermediaire= decoupeLogsBrut($rawRecent);//Découpe les logs en trames


    echo "Intermediaire découpe log=";
    var_dump($intermediaire[0]);
    echo "</br>";

    $res = array(); // On va mettre les trames dans ce tableau

    foreach ($intermediaire as $value) {
        //var_dump(decodageTrame($value));
        array_push($res, decodageTrame($value)); // value = interme[i]
       }
    //    //res est un array d'array de strings qui correspondent à chaque champ

    echo "Tableau res=";
    var_dump($res[0]);
    echo "</br>";


    foreach($res as $trame){
        //trame est un array de string qui correspondent aux champs
        insertTrame($bdd,$trame);
    }

    echo("<br />pieceSelect=<br />");
    var_dump($pieceSelect);
    echo("<br />nouveau repere=<br />");
    var_dump($nouveauRepere);
    insererRepereDansBDD($bdd,$pieceSelect,$nouveauRepere);

    echo("<br />pieceSelect=<br />");
    var_dump($_GET['pieceSelect']);
    echo("<br />nouveau repere=<br />");
    var_dump(strval($nouveauRepere));
    insererRepereDansBDD($bdd,$pieceSelect,$nouveauRepere);
   // insererRepereDansBDD($bdd,$_GET['pieceSelect'],strval($nouveauRepere));
}

function recupLogsBrut(){
    $data=file_get_contents("http://projets-tomcat.isep.fr:8080/appService/?ACTION=GETLOG&TEAM=007D");
    echo "Donnée brute:<br />";
    echo("$data");
    return $data;
}

function decoupeLogsBrutShort($data){

        //usually decoupeLogsBrut is always 1000 in length
        //$data_tab = str_split($data,33);

        //var_dump($data);
        $rev = strrev($data);

        //var_dump(str_split($rev,33));

            return str_split($data, 33);
        //echo "Tabular Data:<br />";
        //var_dump(decodageTrame($data_tab[1]) );
        //return $data_tab;
    }

function decoupeLogsBrut($data){
    $data_tab = str_split($data,33); //découpe le log en paquet de 33
    //echo "Tabular Data:<br />";
    //var_dump(decodageTrame($data_tab[1]) );
    return $data_tab;
}

function decodageTrame($trame){
    return list($typeTrame,$numObjetCemac, $typeRequete, $typeCapteur, $numCapteur, $valeur, $numTrame, $checksum, $year, $month, $day, $hour, $min, $sec) =
        sscanf($trame,"%1s%4s%1s%1s%2s%4s%4s%2s%4s%2s%2s%2s%2s%2s");
}

function decodageTrameLiveChart($trame){
    return list($typeTrame,$numObjetCemac, $typeRequete, $typeCapteur, $numCapteur, $valeur, $numTrame, $checksum, $year, $month, $day, $hour, $min, $sec) =
        sscanf($trame,"%1s%4s%1s%1s%2s%4s%4s%2s%4s%2s%2s%2s%2s%2s");
}

function traiterTrame($trameDecode){
}

function supprTrameDoublons($bdd,$data){
}

function creerTrameEnvoi($bdd,$val,$tim,$num,$idComposant){
    $statement = $bdd->prepare('INSERT INTO `trameenvoi` (val, tim, num, idComposant) 
                                VALUES (:val, :tim, :num, :idComposant)');
    /*
    echo("val=");
    var_dump($val);
    echo("time=");
    var_dump($tim);
    echo ("number=");
    var_dump($num);
    echo ("idcomposant=");
    var_dump($idComposant);
    */
    $statement->bindValue(':val', $val);
    $statement->bindValue(':tim', $tim);
    $statement->bindValue(':num', $num);
    $statement->bindValue(':idComposant', $idComposant);
    $statement->execute();
    //$statement->commit();
}
function insertTrame($bdd,$trame){//ERREUR QQPART ICI
        //echo ("phase 1");
        try {
            $isUnique = true;
            $tim = $trame[8].'-'.$trame[9].'-'.$trame[10].' '.$trame[11] . ':' . $trame[12] . ':' . $trame[13] . '';
            $sth = $bdd->prepare("SELECT idCemac FROM cemac WHERE numeroSerie=:cemac");
            $sth->bindValue(':cemac', $trame[1]);
            $sth->execute();
            $result = $sth->fetchAll();//On recupere Id Cemac

            //echo ("format de temps généré");
            //vérifier qu'on a un résultat.
            //if(isset($result[0]["idCemac"]){
            // $result[0]["idCemac"]
        //}
            //else
            // null;
            $cemac = isset($result[0]["idCemac"]) ? $result[0]["idCemac"] : null;

            //trouver l'id du composant correspondant aux informations de la trame.
            $sth = $bdd->prepare('SELECT DISTINCT idComposant FROM composant 
            INNER JOIN typecapteur ON composant.idTypeCapteur=typecapteur.idTypeCapteur 
            WHERE typecapteur.valeur=:typeCapteur AND composant.idCemac=:cemac AND composant.numComposant=:numComposant');
/*
            echo("<br />idcemac=<br />");
            var_dump($cemac);
            echo("<br />typeCapteur=<br />");
            var_dump($trame[3]);
            echo("<br />numComposant=<br />");
            var_dump($trame[4]);
*/
            $sth->bindValue(':cemac', $cemac);
            $sth->bindValue(':typeCapteur', $trame[3]);
            $sth->bindValue(':numComposant', $trame[4]);
            $sth->execute();
            $result = $sth->fetchAll();

            /*
            echo("<br />result=<br />");
            var_dump($result);
*/
            $idComposant = isset($result[0]["idComposant"]) ? $result[0]["idComposant"] : null;
            /*
            echo("idComposant = ");
            var_dump($idComposant);
*/
            //trouver la trame dans la base de donnée dont le champs time correspond à celui dans la trame mis au format de la bdd(SI elle existe)
            //Cherche Doublons
            $sth = $bdd->prepare("SELECT tim FROM trameenvoi WHERE tim=:tim AND idComposant=:idComp");
            $sth->bindValue(':tim', $tim);
            $sth->bindValue(':idComp', $idComposant);
            $sth->execute();
            $result = $sth->fetchAll();
            //echo("trameBDD=");
            $trameBdd = isset($result[0]) ? $result[0] : null;
            //si trameBDD est set alors on a affaire à un doublon
            if($trameBdd!=null){
                $isUnique=false;
            }
            if($isUnique){
                creerTrameEnvoi($bdd, $trame[5], $tim, $trame[3], $idComposant);
                //echo ("envoyé");
                return true;

            }
            //sinon on crée la trame
            else {
                //echo("pas envoyé");
                return false;
            }
        } catch (Exception $e) {
            return false;
        }
}

function recupRepere($bdd,$pieceSelect){
    $sth = $bdd->prepare("SELECT repere FROM cemac WHERE idPiece=:num");
    $sth->bindValue(':num',$pieceSelect);
    $sth->execute();
    $result = $sth->fetchAll();
    return intval($result[0][0]);
}

function insererRepereDansBDD($bdd,$pieceSelect,$nouveauRepere){
    $sth = $bdd->prepare("UPDATE cemac SET repere= :nouveauRepere WHERE idPiece= :num");
    $sth->bindValue(':num',$pieceSelect);
    $sth->bindValue(':nouveauRepere',$nouveauRepere);
    $sth->execute();
}



